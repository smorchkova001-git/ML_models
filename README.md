# **Домашнее задание №1**

Была проделана работа по построению линейной регрессии для прогнозирования стоимости автомобиля. 

Для этого используются следующие признаки:
- Марка автомобиля (name)
- Год выпуска (year)
- Пробег (km_driven), км
- Тип топлива (fuel)
- Тип продавца (seller_type)
- Тип коробки передач (transmission)
- Владелец (owner)
- Расход топлива (mileage), kmpl
- Объем двигателя (engine), CC
- Максимальная мощность (max_power), bhp
- Количество мест (seats)

## **Часть 1 | EDA и визуализация**

1) Пропуски были выявлены для нескольких признаков, которых после преобразований удалось привести к числовым. После чего пропуски были заменены на медиану признака по обучающей выборке
2) Были выявлены полностью дублирующиеся строки и строки с частичным повторением информации (с разными значениями целевой переменной). Дубли были удалены в обучаюей выборке
3) С помощью библиотеки ydata_profiling были построены автоматические дашборды по обучающей и тестовой выборке

    **Выводы по дашбордам:**

    **df_train:**
    - в датасете довольно много дублирующихся строк (7%)
    - в нескольких столбцах есть пропуски (но не в таргете)
    - некоторые переменные имеют высокую корреляцию с ценой (transmission, year)

    **df_test:**
    - все еще есть дубли, но меньше (3%)
    
    В остальном то же самое:
    - в нескольких столбцах есть пропуски (но не в таргете)
    - некоторые переменные имеют высокую корреляцию с ценой (transmission, year)

4) По числовым и категориальным стообцам для трейна и теста были построены основные описательные статистики до заполнения пропусков и после, чтобы убедиться, что мы не исказили датасеты


    **Выводы по статистикам до преобразования и после**

    **df_train**

    - Есть некоторые изменения, которые связаны с удалением дублей. В первую очередь упало среднее по selling_price на 18%.

    - Для признаков, в которых мы заполняли пропуски среднее поменялось незначительно, медиана не изменилась (что логично)

    - Ни кол-во категорий, ни самая частая категория не изменились после удаления дублей ни для каких категориальных признаков

    **df_test**

    Изменения схожие на df_train:

    - Среднее по selling_price упало на 11% соответсвенно

    - Для признаков, в которых мы заполняли пропуски среднее поменялось незначительно, медиана тоже поменялась (ведь мы заменяли nan на медиану по трейну), но также незначительно

    - Ни кол-во категорий, ни самая частая категория не изменились после удаления дублей ни для каких категориальных признаков

    **Основной вывод:** при удалении дубликатов вероятно стоило оставлять не первое вхождение, в вхождение со средней (медианой) цены по дублирующимся строкам

    **Выводы по статистикам между train и test (после преобразования)**

    - В целом кажется, что никаких значительных различий, из-за которых модель будет совсем невалидна, нет. Есть небольшие разницы в средних, но они не критичны, медианы еще более схожи. В train в столбце km_driven есть сильно отличающейся от test минимум (1 vs 1303), максимум у mileage и max_power тоже имеют большие относительные отличия, но опять же средние и медианы не имеют значительных различий, поэтому это не должно стть препятсвием для модели

    - По категориальным признакам train и test тоже не сильно отличаются, за исключением столбца name. В нем изменилась самая частая категория и у test в 3 раза меньше уникальных категорий, что может быть объяснено меньшей выборкой, в которую смогли попасть не все категории

5) Были построены pairplot для обучающей и тестовой выборки

    Гипотезы о наличии связи между параметров на основе pairplot:

    Видно, что цена действительно коррелирует с некоторыми признаками. Прямопропорционально с year, engine (при маленьких значениях признака маленькая цена, но при дальнейшем увеличении engine зависимость не такая четкая) и max_power. Обратнопропорционально с km_driven. В целом, это довольно логичные взаимосвязи
    Также кажется, что цена не имеет особой связи с mileage. А вот зависимость цены от кол-ва сидений сначала кажется нелогичной: у машин с большим кол-вом сидений цена ниже

    Судя по графику, у engine, max_power и mileage может быть довольно высокая попарная корреляция. В целом, высокая корреляция между engine и max_power ожидаема

    Графики остальных признаков не похожи на значительную линейную коррекляцию

    Как и было видно по описательным статистикам, train и test не имеют существенных отличий. Зависимости цены от фичей у test схожи с train, зависимости между фичами также похожи

6) Были построены две матрицы корреляции: Пирсона и Спирмана

    **Выводы по корреляции Пирсона:**

    Не все гипотезы, основанные на графиках, подтвердились, но в целом коэффициенты корреляции ожидаемы.
- Меньше всего коррелируют engine и year, практически нулевая корреляция
- У нас нет совсем высоких корреляций (больше 0.7), тем не менее с ценой хорошо (и положительно) коррелирует max_power; max_power и engine, engine и seats хорошо коррелируют между собой. Цена имеет умеренную корреляцию с engine и year
- Корреляция между годом и кол-вом км имеет корреляцию -0,37. То есть, да, взаимосвязь действительно скорее обратная, чем прямая, но это уже довольно низкий коэффициент корреляции и по scatter plot эту зависимость не особо видно, так что здесь нужно быть аккуратнее с выводами, лучше провести доп исследование

    **Выводы по корреляции Спирмана:**

    Следует построить корреляцию Спирмена, так как корреляция Пирсона показывает только линейную связь, а корреляция Спирмана может показать монотонную связь между столбцами

    По сравнению с Пирсоном корреляция Спирмена показала гораздо более высокие значения между ценой и годом выпуска, а также более высокую корреляцию между year и km_driven

7) Был рассмотрен box_plot для таргета, чтобы увидеть есть ли в выборке экстремальные значения или она довольно однородна. Оказалось, действительно есть много экстремальных значений, которые выше чем Q3 + 1,5IQR. Не будем их удалять, так как это не невозможные данные (машина может стоить 10 млн (предположим) долларов)

8) Для линейной регрессии также важно понимать, имеет ли целевая переменная нормальное распределение. Если нет, то для получения хороших результатов лучше каким-то образом привести ее к нормальной (например, логорифмировать). Судя по получившейся гистограмме, распределение не похоже на нормальное, для получения лучших результатов следует логарифмировать


## **Часть 2 | Модель только на вещественных признаках**

Было обучено несколько моделей по вещественным признакам:
1) Классическая линейная регрессия

    Результаты:

    Для трейна:

        MSE = 116,616,259,932
        R2 = 0.5932
        
    Для теста:

        MSE = 233,059,669,372
        R2 = 0.5946

    С интерпретацией MSE стандартная проблема: она не ограничена сверху и измеряется в величине в квадрате (в нашем случае валюта^2), поэтому сказать большая она или нет нельзя. Тем не менее на тесте она выше, чем на трейне (хотя по RMSE не так сильно), вероятно это из-за того, что на трейне мы обучались, а тест - это новые данные

    R2, с другой стороны ограничен сверху (единичкой) и по нему можно сделать вывод, что результат в 0.595 - нормальный результат для бейзлайн модели. При этом r2 на трейне практически такой же, что значит, что модель не переучилась

2) Линейная регрессия со стандартизацией признаков

    Результаты:

    Для трейна:

        MSE = 116,616,259,932
        R2 = 0.5932
        
    Для теста:

        MSE = 233,059,669,372
        R2 = 0.5946

    Качество модели не изменилось, поменялись только коэффициенты
    Наиболее информативный признак - max_power

3) Линейная регрессия со стандартизаций и регуляризацией Lasso

    Результаты:

    Для трейна:

        MSE = 116,616,259,942
        R2 = 0.5932
    
    Для теста:

        MSE = 233,060,336,698
        R2 = 0.5946

- Lasso не улучшило качество модели, тк R2 не изменился, а MSE даже немного увеличилось
- Веса также практически не изменились и не были занулены. Могу предположить, что это значит что все признаки имеют влияние на таргет и если какой-то вес занулись, то качество ухудшится

4) Линейная регрессия со стандартизаций и регуляризацией Lasso с подбором гиперпараметра с помощью GridSearchCV

    Результаты:

    Для трейна:

        MSE = 116,616,260,940
        R2 = 0.5932
        
    Для теста:

        MSE = 233,066,358,947
        R2 = 0.5945

    Выводы:
    - подбором гиперпараметра с помощью GridSearchCV не удалось улучшить качество модели
    - GridSearchCV обучил 50 моделей (перебирали 5 гиперпараметров, для каждого - по 10 фолдов)
    - лучший коэффициент регуляризации с помощью GridSearchCV - 10, но на самом деле изменения в метриках качества настолько малы, что это может быть просто погрешность
    - никакие веса не были занулены

5) Линейная регрессия со стандартизаций и регуляризацией ElasticNet с подбором гиперпараметра с помощью GridSearchCV

    Результаты:

    Для трейна:

        MSE = 118,848,042,289
        R2 = 0.5854
        
    Для теста:

        MSE = 251,768,241,865
        R2 = 0.5620

    Выводы:

    - ElasticNet не удалось улучшить качество модели
    - Обучилось 250 моделей (перебирали 5 гиперпараметров коэф регуляризации, для каждого по 5 l1_ration, для каждого - по 10 фолдов)
    - лучшей модели соответсвуют гиперпараметры alpha=0.5, l1_ratio=0.7


## **Часть 3| Добавляем категориальные фичи**
Для улучшений модели был преобразован столбец name, у которого изначально было слишком много уникальных значений для OHE. В результате преобразования кол-во категорий сократилось до 30 на трейне и 25 на тесте

Этот и другие категориальные признаки были разбиты на отдельные столбцы с помощью OHE

Линейная регрессия со стандартизаций и регуляризацией Ridge с подбором гиперпараметра с помощью GridSearchCV

Результаты:

Для трейна:

    MSE = 65,600,935,281
    R2 = 0.7711
    
Для теста:

    MSE = 126,036,182,368
    R2 = 0.7807

Качество прогноза занчительно улучшилось после добавления категориальных переменных. Судя по коэффициентам особую роль сыграло преобразование и учет в модели столбца с маркой автомобиля


## **Часть 4. | Бизнесовая**

Проверяем качество всех построенных моделей на бизнесовой метрике: доле прогнозов, отличающихся от реальных цен на эти авто не более чем на 10%

Лучшей моделью по бизнес метрике, как и по R2 и MSE, стала модель с учетом  категоральных признаков с Ridge регуляризацией

Тем не менее даже она показывает очень низкое качество: 70% предиктов отклоняются от реальных значений более чем на 10%


## **Часть 5 | Создание интерактивного приложения на Streamlit**

Было создано интерактивное приложение на Streamlit, которое доступно по [ссылке](https://linear-ml-models-smorchkova-juliana.streamlit.app/) и которое можно запустить командой streamlit run app.py

Это приложение позволяет:
- Предсказывать стоимость автомобиля по его характеристикам
- Анализировать данные с помощью интерактивных графиков
- Изучать коэффициенты обученной модели

Для навигации между разделами реализовано боковое меню


## **Часть 6 | Оформление репозитория и оценка сервиса**

Все необходимые файлы оформлены в [GitHub](https://github.com/smorchkova001-git/ML_models/tree/main), включая ipynb ноутбук, app.py и другие страницы в папке pages для Streamlit, лучшая модель, сохраненная в формате pickle и т.д. 


## **Общие выводы**
- наилучшая полученная модель - линейная регрессия со стандартизаций и регуляризацией Ridge с подбором гиперпараметра с помощью GridSearchCV, постороенная на вещественных и категориальных фичах. Ее метрики качества 
MSE = 126,036,182,368 и R2 = 0.7807

- наибольший прирост качества дало добавление категориальных признаков (особенно марки автомобиля)

- что сделать не удалось: не удалось достичь качества выше 0.79 по R2

    В остальном хотелось бы скорее отметить что можно улучшить:
    -	при удалении дублей оставлять не первое вхождение, а вхождение со средней/медианной ценой среди дубликатов с такими признаками
    -	логарифмировать целевую переменную, так как ее распределение не нормально
    -	обработать столбец torque

- разработанное приложение удобно для использования в связи с разделением на многостраничность и, как следствие, боковое меню. Возможность интерактивно строить графики, выбирать признаки и датасет построения. Визуализация графиков легко настраивается. Что хотелось бы улучшить: для EDA добавить фильтры в поле слева, которые действовали бы на все графики сразу; подгружать модель один раз для всех страниц